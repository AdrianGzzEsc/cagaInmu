<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    
        <link rel="stylesheet" href="/css/style.css">

    <!--Fontawesome-->
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
  
    <link rel="stylesheet" href="https://unpkg.com/accordion-js@3.3.1/dist/accordion.min.css" />

    <script src='https://unpkg.com/accordion-js@3.3.1/dist/accordion.min.js'></script>


</head>

<body style="background-image: url('/imagenes/background.png');">
    <br>
    <div class="d-flex justify-content-center">
        <h3>
            <img width="280" height="140"
                src="https://i0.wp.com/inmu.mx/wp-content/uploads/2022/08/1.png?fit=480%2C240&amp;ssl=1" alt="INMU">
        </h3>
    </div>
    <video id="myvid" style="display: none;"> </video>

    <div class="container">

        <div class="row">
            <div class="col-6 card p-3">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <a class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" href="#nav-home" role="tab"
                            aria-controls="nav-home" aria-selected="true">Imagenes Swipper</a>
                        <a class="nav-link" id="nav-casa-tab" data-bs-toggle="tab" href="#nav-casa" role="tab"
                            aria-controls="nav-casa" aria-selected="false">Detalles Casa</a>
                        <a class="nav-link" id="nav-depa-tab" data-bs-toggle="tab" href="#nav-depa" role="tab"
                            aria-controls="nav-depa" aria-selected="false">Detalles Depa</a>
                  
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                        <%- include ("../swiper") %>

                    </div>
                    <div class="tab-pane fade" id="nav-casa" role="tabpanel" aria-labelledby="nav-casa-tab">
                        <%- include ("./templates/casa") %>

                    </div>
                    <div class="tab-pane fade" id="nav-depa" role="tabpanel" aria-labelledby="nav-depa-tab">
                        
                        <%- include ("./templates/depa") %>

                    </div>
                
                </div>
            </div>
            <div id="preview" class="col-4 card ml-5" style="max-height: 700px;background-color: rgba(255,255,255,0.8);padding: 0px;">

            </div>
        </div>
        <a id="crear" style="right:5px;background-color: #e3f977;font-family: inmu;border-color: black;" class="col-6 btn btn-primary mt-2">Crear</a>

        <br>
        <br>
    </div>
</body>

<script>
    function sleep(miliseconds) {
        var currentTime = new Date().getTime();

        while (currentTime + miliseconds >= new Date().getTime()) {
        }
    }

    const delay = ms => new Promise(res => setTimeout(res, ms));


    var contactTemplate = ` <%- include ("./templates/contactTemplate") %> `
    var formTemplate = ` <%- include ("./templates/swiperTemplate") %> `
    var formTemplate2 = ` <%- include ("./templates/planosTemplate") %> `


    $(document).on('click', '.acContactar', function (e) {
        $('.ac-trigger').each(function () {
            if (!$(this).hasClass('acContactar') && $(this).parent().parent().hasClass('is-active'))
                acc.close($(this).index('.ac-trigger'))
        })
    })

    $(document).on('click', '.ac-trigger', function (e) {
        if (!$(this).hasClass("acContactar")) {

            if ($('.acCustom').hasClass('is-active'))
                acc.close($('.acCustom').find('.ac-trigger').index('.ac-trigger'))
        }

    });


    $(document).on('click', '#mas', function () {
        $(formTemplate).appendTo('#content').slideDown('normal');

        $("html, body").animate({ scrollTop: $(document).height() }, 1000);
    });

    $(document).on('click', '#menos', function () {
        $(this).closest('[name = materiales]').slideUp("normal", function () { $(this).remove(); });

        var index = $(this).closest('[name = materiales]').index('[name = materiales]')
        if (duration[index] != undefined)
            duration.splice(index,1)
    });

    $(document).on('click', '#mas2', function () {
        $(formTemplate2).appendTo('#content2').slideDown('normal');

        $("html, body").animate({ scrollTop: $(document).height() }, 1000);
    });

    $(document).on('click', '#menos2', function () {
        $(this).closest('[name = materiales2]').slideUp("normal", function () { $(this).remove(); });

    });

    //Handler de videos para agregar su duracion
    var myvid = document.getElementById('myvid');
    var duration = []
    $(document).on('change', '[name = linkSwipper]', async function () {
        index = $(this).index('[name = linkSwipper]')
        if ($(this).val().includes('mp4')) {
            $('#myvid').attr("src", $(this).val())
            myvid.addEventListener('durationchange', function () {
                duration[index] = String(myvid.duration).replace(".", "")
                console.log(duration)
            });
        }
    })

    function multipleExist(arr, values) {
        return values.every(value => {
            return arr.includes(value);
        });
    }


    $(document).on('click', '#crear', async function () {
        var template = '<div class="swiper mySwiper"><div class="swiper-wrapper">'
        var categorias = []
        var data = {}
        $('[name = linkSwipper]').each(async function () {
            index = $(this).index('[name = linkSwipper]')
            if ($(this).val().includes('mp4')) {
                template += '<div class="swiper-slide" data-swiper-autoplay="' + duration[index] + '"><a class="wplightbox" data-group="gallery0" href="' + $(this).val() + '" data-thumbnail="' + $(this).val() + '"><video class="wpgmza-embedded-media" src="' + $(this).val() + '"></a></div>'
            } else {
                template += '<div class="swiper-slide"><a class="wplightbox" data-group="gallery0"  href="' + $(this).val() + '" data-thumbnail="' + $(this).val() + '"><img class="wpgmza-embedded-media" src="' + $(this).val() + '"></a></div>'
            }
        })

        template += '</div> <div class="swiper-button-next"></div><div class="swiper-button-prev"></div><div class="swiper-pagination"></div></div>'
        if ($('#nav-casa-tab').hasClass('active')) {
            var casaCat = ["1", "9", "25", "10"]
            categorias.push("1")


            $('#nav-casa').find('[name = amenidad]').each(function () {
                if ($(this).is(":checked"))
                    categorias.push($(this).val())
            })
            if (!multipleExist(casaCat, categorias))
                categorias.push("11")

            data.categorias = categorias
            data.recorrido = $('#nav-casa').find('[name = recorrido]').val()
            data.precio = $('#nav-casa').find('[name = precioRango]').val()
            data.descripcion = $('#nav-casa').find('[name = descripcion]').val()

            data.customFields = []
            if ($('#nav-casa').find('[name = detalles]').val() != "")
                data.customFields.push({ name: "Descripcion", value: $('#nav-casa').find('[name = detalles]').val() })
            
                if ($('#nav-casa').find('[name = precioRango]').val() != "")
            data.customFields[1] = { name: "Precio", value: $('#nav-casa').find('[name = precioRango]').val() }
            else return alert('Falta Precio')

            data.customFields[2] = { name: "Metros", value: $('#nav-casa').find('[name = metros]').val() }
            data.customFields[3] = { name: "Estacionamiento", value: $('#nav-casa').find('[name = estacionamiento]').val() }
            data.customFields[4] = { name: "Habitaciones", value: $('#nav-casa').find('[name = habitaciones]').val() }
            data.customFields[5] = { name: "Baños", value: $('#nav-casa').find('[name = baños]').val() }

        } else if ($('#nav-depa-tab').hasClass('active')) {
            categorias.push("2")

            $('#nav-depa').find('[name = amenidad]').each(function () {
                if ($(this).is(":checked"))
                    categorias.push($(this).val())

            })
            if (!multipleExist(casaCat, categorias))
                categorias.push("7")

            data.categorias = categorias
            data.recorrido = $('#nav-depa').find('[name = recorrido]').val()
            data.precio = $('#nav-depa').find('[name = precioRango]').val()
            data.descripcion = $('#nav-depa').find('[name = descripcion]').val()

            data.customFields = []

            data.customFields[1] = { name: "Precio", value: $('#nav-depa').find('[name = precioRango]').val() }

        }
        else
            return alert('Asegurate de estar en pestaña de Casa o Departamento')

        console.log(data)

        if (data.recorrido != "")
            template += '<div id="iframeLoad"><a href="' + data.recorrido + '" class="wplightbox">RECORRIDO VIRTUAL</a></div>'

            template += '<div id="precioINMU" style = "text-align: center;font-family: inmu;font-size: 32px;" ></div>'
   

        template += '<div class="accordion-container scrollableC"><div class="ac"><h2 class="ac-header"> <button type="button" class="ac-trigger">Detalles del Inmueble</button></h2><div class="ac-panel"><div class="ac-text"></div></div></div>'


        template += '<div class="ac acCustom"><h2 class="ac-header"> <button type="button" class="ac-trigger acContactar">Contactar</button></h2><div class="ac-panel"><div class="ac-text" id="contactForm">Contactar</div></div></div></div>'

        $('#preview').html(template)



        var iconos = ''
        if (data.customFields.filter(e => e.name === 'Descripcion').length > 0) {
            iconos += '<div name="inmuDescripcion">' + data.customFields[0].value + '</div>'
            data.customFields.splice(0, 1)

        }
        $('#precioINMU').html(data.customFields.filter(e => e.name === 'Precio')[0].value)
            data.customFields.splice(0, 1)
         
        
       

        iconos += '<div class="row ml-3" style="justify-content: space-between;">'
        for (var i = 0; i < data.customFields.length; i++) {
            iconos += '<div style ="width: 120px !important;" class= "row mt-2 pt-1 pb-1" ><div class="col-3" style="display: flex; align-items: center;"> <i style ="height: 35px;width:35px;margin-top:-2px" class ="inmu' + data.customFields[i].name + '"></i></div><div class="col-3 ml-3" style="display: flex; align-items: center;">' + data.customFields[i].value + '</div></div>'
        }
        iconos += "</div>"
        $('.ac-text').eq(0).append(iconos)

        $('#contactForm').html(contactTemplate)

        $('video.wpgmza-embedded-media').attr('webkit-playsinline', '')
        $('video.wpgmza-embedded-media').attr('playsinline', '')
        $('video.wpgmza-embedded-media').trigger('play')
        $('video.wpgmza-embedded-media').removeAttr('controls');
        $('video.wpgmza-embedded-media').attr('loop', '')
        var swiper = new Swiper(".mySwiper", {
            loop: false,
            centeredSlides: true,
            speed: 1000,

            autoplay: {
                delay: 3000,
                disableOnInteraction: false,
                pauseOnMouseEnter: true,
            },
            pagination: {
                el: ".swiper-pagination",
                clickable: true
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev"
            }
        });

        acc = new Accordion('.accordion-container', {
            duration: 400,
            showMultiple: true,
        });
        acc.open(0)

        console.log(template)
        console.log(data)
/*
        fetch("/", {
                    method: "POST",
                    body: JSON.stringify(data),
                    headers: {
                    'Content-Type': 'application/json'
                }
                }).then(response => {
                    if (response.ok) {

                        return response.json();
                    }
                    throw new Error(response.statusText);
                })
                .then(responseJSON => {

                    window.location.href = "/ordenes-compra/"
                })
                .catch(err => {

                    alert(err.message)
                })
                */
    });



</script>


</html>